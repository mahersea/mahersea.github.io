<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multi-Quadrant Explosion Simulation with Raga Tones</title>
  <style>
    body {
      margin: 0;
      background-color: rgb(33, 33, 33);
      color: white;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    /* Global Controls */
    #globalControls {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 100;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 5px;
    }
    /* Quadrant Grid Layout */
    #quadrantContainer {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      width: 100vw;
      height: 100vh;
    }
    .quadrant {
      position: relative;
      overflow: hidden;
      border: 1px solid #333;
    }
    canvas {
      width: 100%;
      height: 100%;
      background-color: black;
    }
    /* Local Controls for Each Quadrant */
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(0,0,0,0.5);
      padding: 5px;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      /* Hidden by default */
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    /* Show controls when mouse is over the quadrant */
    .quadrant:hover .controls {
      opacity: 1;
    }
    select, button {
      padding: 5px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Global Controls -->
  <div id="globalControls">
    <button id="globalAutoTrigger">Toggle Global Auto-Trigger</button>
  </div>
  
  <!-- Quadrant Container -->
  <div id="quadrantContainer">
    <!-- Quadrant 1 -->
    <div class="quadrant" id="quad1">
      <div class="controls">
        <label>Explosion:</label>
        <select class="explosionSelect">
          <option value="field">Field Explosion</option>
          <option value="blob">Blob Explosion</option>
          <option value="wave">Wave Explosion</option>
          <option value="hybrid">Hybrid Explosion</option>
        </select>
        <label>Raga:</label>
        <select class="ragaSelect">
          <option value="none" selected>None</option>
          <option value="Bilawal">Bilawal</option>
          <option value="Yaman">Yaman</option>
          <option value="Kalyan">Kalyan</option>
          <option value="Bhairavi">Bhairavi</option>
        </select>
        <label>Time Signature:</label>
        <select class="timeSignatureSelect">
          <option value="2000">Whole Note (2000ms)</option>
          <option value="1000">Half Note (1000ms)</option>
          <option value="500" selected>Quarter Note (500ms)</option>
          <option value="250">Eighth Note (250ms)</option>
          <option value="125">Sixteenth Note (125ms)</option>
        </select>
        <button class="muteToggle">
          <span class="muteIcon">ðŸ”‡</span>
          <span class="muteLabel">Muted</span>
        </button>
      </div>
      <canvas id="canvas1"></canvas>
    </div>
    <!-- Quadrant 2 -->
    <div class="quadrant" id="quad2">
      <div class="controls">
        <label>Explosion:</label>
        <select class="explosionSelect">
          <option value="field">Field Explosion</option>
          <option value="blob">Blob Explosion</option>
          <option value="wave">Wave Explosion</option>
          <option value="hybrid">Hybrid Explosion</option>
        </select>
        <label>Raga:</label>
        <select class="ragaSelect">
          <option value="none" selected>None</option>
          <option value="Bilawal">Bilawal</option>
          <option value="Yaman">Yaman</option>
          <option value="Kalyan">Kalyan</option>
          <option value="Bhairavi">Bhairavi</option>
        </select>
        <label>Time Signature:</label>
        <select class="timeSignatureSelect">
          <option value="2000">Whole Note (2000ms)</option>
          <option value="1000">Half Note (1000ms)</option>
          <option value="500" selected>Quarter Note (500ms)</option>
          <option value="250">Eighth Note (250ms)</option>
          <option value="125">Sixteenth Note (125ms)</option>
        </select>
        <button class="muteToggle">
          <span class="muteIcon">ðŸ”‡</span>
          <span class="muteLabel">Muted</span>
        </button>
      </div>
      <canvas id="canvas2"></canvas>
    </div>
    <!-- Quadrant 3 -->
    <div class="quadrant" id="quad3">
      <div class="controls">
        <label>Explosion:</label>
        <select class="explosionSelect">
          <option value="field">Field Explosion</option>
          <option value="blob">Blob Explosion</option>
          <option value="wave">Wave Explosion</option>
          <option value="hybrid">Hybrid Explosion</option>
        </select>
        <label>Raga:</label>
        <select class="ragaSelect">
          <option value="none" selected>None</option>
          <option value="Bilawal">Bilawal</option>
          <option value="Yaman">Yaman</option>
          <option value="Kalyan">Kalyan</option>
          <option value="Bhairavi">Bhairavi</option>
        </select>
        <label>Time Signature:</label>
        <select class="timeSignatureSelect">
          <option value="2000">Whole Note (2000ms)</option>
          <option value="1000">Half Note (1000ms)</option>
          <option value="500" selected>Quarter Note (500ms)</option>
          <option value="250">Eighth Note (250ms)</option>
          <option value="125">Sixteenth Note (125ms)</option>
        </select>
        <button class="muteToggle">
          <span class="muteIcon">ðŸ”‡</span>
          <span class="muteLabel">Muted</span>
        </button>
      </div>
      <canvas id="canvas3"></canvas>
    </div>
    <!-- Quadrant 4 -->
    <div class="quadrant" id="quad4">
      <div class="controls">
        <label>Explosion:</label>
        <select class="explosionSelect">
          <option value="field">Field Explosion</option>
          <option value="blob">Blob Explosion</option>
          <option value="wave">Wave Explosion</option>
          <option value="hybrid">Hybrid Explosion</option>
        </select>
        <label>Raga:</label>
        <select class="ragaSelect">
          <option value="none" selected>None</option>
          <option value="Bilawal">Bilawal</option>
          <option value="Yaman">Yaman</option>
          <option value="Kalyan">Kalyan</option>
          <option value="Bhairavi">Bhairavi</option>
        </select>
        <label>Time Signature:</label>
        <select class="timeSignatureSelect">
          <option value="2000">Whole Note (2000ms)</option>
          <option value="1000">Half Note (1000ms)</option>
          <option value="500" selected>Quarter Note (500ms)</option>
          <option value="250">Eighth Note (250ms)</option>
          <option value="125">Sixteenth Note (125ms)</option>
        </select>
        <button class="muteToggle">
          <span class="muteIcon">ðŸ”‡</span>
          <span class="muteLabel">Muted</span>
        </button>
      </div>
      <canvas id="canvas4"></canvas>
    </div>
  </div>
  
  <script>
    // --- Global Audio Setup ---
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    function createQuadrantGainNode() {
      const gainNode = audioContext.createGain();
      gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
      gainNode.connect(audioContext.destination);
      return gainNode;
    }
    
    // --- Random Extra Delay ---
    function getRandomExtraDelay() {
      const delayOptions = [
        { delay: 125, weight: 10 },
        { delay: 250, weight: 10 },
        { delay: 375, weight: 5 },
        { delay: 500, weight: 10 },
        { delay: 750, weight: 5 },
        { delay: 1000, weight: 10 },
        { delay: 1125, weight: 5 },
        { delay: 1500, weight: 5 },
        { delay: 2000, weight: 5 },
        { delay: 3000, weight: 1 },
        { delay: 4000, weight: 1 }
      ];
      const totalWeight = delayOptions.reduce((sum, option) => sum + option.weight, 0);
      let random = Math.random() * totalWeight;
      for (const option of delayOptions) {
        if (random < option.weight) {
          return option.delay;
        }
        random -= option.weight;
      }
      return 125;
    }
    
    // --- Explosion Simulation Class ---
    class ExplosionSimulation {
      constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.resizeCanvas();
        window.addEventListener('resize', () => this.resizeCanvas());
        this.explosions = [];
        this.currentExplosionType = 'field';
      }
      
      resizeCanvas() {
        this.canvas.width = this.canvas.clientWidth;
        this.canvas.height = this.canvas.clientHeight;
      }
      
      createExplosion(x, y) {
        if (this.currentExplosionType === 'field') {
          this.fieldExplosion(x, y);
        } else if (this.currentExplosionType === 'blob') {
          this.blobExplosion(x, y);
        } else if (this.currentExplosionType === 'wave') {
          this.waveExplosion(x, y);
        } else if (this.currentExplosionType === 'hybrid') {
          this.hybridExplosion(x, y);
        }
      }
      
      fieldExplosion(x, y) {
        const fieldSize = 100;
        const intensity = 10;
        for (let dx = -fieldSize; dx < fieldSize; dx += 10) {
          for (let dy = -fieldSize; dy < fieldSize; dy += 10) {
            const distance = Math.sqrt(dx * dx + dy * dy);
            if (distance < fieldSize) {
              const falloff = 1 - (distance / fieldSize);
              this.explosions.push({
                x: x + dx,
                y: y + dy,
                radius: falloff * intensity,
                color: this.getColorFromX(x + dx),
                life: 1,
                type: 'field'
              });
            }
          }
        }
      }
      
      blobExplosion(x, y) {
        const blobCount = 5;
        const maxRadius = 50;
        for (let i = 0; i < blobCount; i++) {
          this.explosions.push({
            x: x + (Math.random() - 0.5) * 50,
            y: y + (Math.random() - 0.5) * 50,
            radius: Math.random() * maxRadius,
            color: this.getColorFromX(x),
            life: 1,
            vx: (Math.random() - 0.5) * 5,
            vy: (Math.random() - 0.5) * 5,
            type: 'blob'
          });
        }
      }
      
      waveExplosion(x, y) {
        const waveCount = 3;
        const maxRadius = 200;
        for (let i = 0; i < waveCount; i++) {
          this.explosions.push({
            x: x,
            y: y,
            radius: 0,
            maxRadius: maxRadius * (i + 1) / waveCount,
            color: this.getColorFromX(x),
            life: 1,
            growthRate: 5,
            type: 'wave'
          });
        }
      }
      
      hybridExplosion(x, y) {
        this.fieldExplosion(x, y);
        const blobCount = 3;
        const maxRadius = 30;
        for (let i = 0; i < blobCount; i++) {
          this.explosions.push({
            x: x + (Math.random() - 0.5) * 100,
            y: y + (Math.random() - 0.5) * 100,
            radius: Math.random() * maxRadius,
            color: this.getColorFromX(x),
            life: 1,
            vx: (Math.random() - 0.5) * 3,
            vy: (Math.random() - 0.5) * 3,
            type: 'hybrid'
          });
        }
        const waveCount = 2;
        const maxWaveRadius = 150;
        for (let i = 0; i < waveCount; i++) {
          this.explosions.push({
            x: x,
            y: y,
            radius: 0,
            maxRadius: maxWaveRadius * (i + 1) / waveCount,
            color: this.getColorFromX(x),
            life: 1,
            growthRate: 3,
            type: 'hybrid'
          });
        }
      }
      
      getColorFromX(x) {
        const hue = (x / this.canvas.width) * 360;
        return `hsla(${hue}, 100%, 50%, 0.5)`;
      }
      
      render() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.explosions = this.explosions.filter(explosion => {
          switch (explosion.type) {
            case 'field':
              this.ctx.beginPath();
              this.ctx.fillStyle = explosion.color;
              this.ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
              this.ctx.fill();
              explosion.life -= 0.02;
              break;
            case 'blob':
              this.ctx.beginPath();
              this.ctx.fillStyle = explosion.color;
              this.ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
              this.ctx.fill();
              explosion.x += explosion.vx;
              explosion.y += explosion.vy;
              explosion.radius *= 0.95;
              explosion.life -= 0.03;
              break;
            case 'wave':
              this.ctx.beginPath();
              this.ctx.strokeStyle = explosion.color;
              this.ctx.lineWidth = 5;
              this.ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
              this.ctx.stroke();
              explosion.radius += explosion.growthRate;
              explosion.life -= 0.02;
              break;
            case 'hybrid':
              if (explosion.maxRadius) {
                this.ctx.beginPath();
                this.ctx.strokeStyle = explosion.color;
                this.ctx.lineWidth = 3;
                this.ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
                this.ctx.stroke();
                explosion.radius += explosion.growthRate;
                explosion.life -= 0.02;
              } else {
                this.ctx.beginPath();
                this.ctx.fillStyle = explosion.color;
                this.ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
                this.ctx.fill();
                explosion.x += explosion.vx;
                explosion.y += explosion.vy;
                explosion.radius *= 0.95;
                explosion.life -= 0.03;
              }
              break;
          }
          return explosion.life > 0;
        });
        requestAnimationFrame(this.render.bind(this));
      }
    }
    
    // --- Sound Functions ---
    function playOscillatorSound(frequency, destination) {
      const oscillator = audioContext.createOscillator();
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
      const gainNode = audioContext.createGain();
      gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
      oscillator.connect(gainNode);
      gainNode.connect(destination);
      oscillator.start();
      gainNode.gain.linearRampToValueAtTime(0.0, audioContext.currentTime + 1);
      oscillator.stop(audioContext.currentTime + 1);
    }
    
    // Returns a base frequency based on vertical position.
    function getFrequencyFromY(y, canvasHeight) {
      const fMax = 880;
      const fMin = 220;
      return fMax - (y / canvasHeight) * (fMax - fMin);
    }
    
    // Returns a raga frequency based on the selected raga.
    function getRagaFrequency(controlsContainer) {
      const ragaSelect = controlsContainer.querySelector('.ragaSelect');
      const raga = ragaSelect ? ragaSelect.value : 'none';
      const scales = {
        Bilawal: [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88],
        Yaman: [293.66, 329.63, 369.99, 392.00, 440.00, 493.88, 554.37],
        Kalyan: [261.63, 293.66, 329.63, 369.99, 392.00, 440.00, 493.88],
        Bhairavi: [261.63, 277.18, 311.13, 349.23, 392.00, 415.30, 466.16]
      };
      if (raga !== 'none' && scales[raga]) {
        const scale = scales[raga];
        return scale[Math.floor(Math.random() * scale.length)];
      }
      return null;
    }
    
    // --- Quadrant Controller ---
    class QuadrantController {
      constructor(canvas, controls, gainNode) {
        this.canvas = canvas;
        this.controls = controls;
        this.gainNode = gainNode;
        this.simulation = new ExplosionSimulation(canvas);
        this.simulation.currentExplosionType = controls.querySelector('.explosionSelect').value;
        this.autoTriggerInterval = parseInt(controls.querySelector('.timeSignatureSelect').value);
        this.channelMuted = true;
        this.autoTriggerActive = false;
        this.localAutoTriggerTimeout = null;
        this.bindLocalControls();
        this.bindCanvasEvents();
        this.setupTimeSignatureControl();
        this.simulation.render();
      }
      
      bindLocalControls() {
        const explosionSelect = this.controls.querySelector('.explosionSelect');
        explosionSelect.addEventListener('change', (e) => {
          this.simulation.currentExplosionType = e.target.value;
        });
        const muteToggle = this.controls.querySelector('.muteToggle');
        muteToggle.addEventListener('click', () => {
          this.channelMuted = !this.channelMuted;
          const muteIcon = this.controls.querySelector('.muteIcon');
          const muteLabel = this.controls.querySelector('.muteLabel');
          muteIcon.textContent = this.channelMuted ? 'ðŸ”‡' : 'ðŸ”Š';
          muteLabel.textContent = this.channelMuted ? 'Muted' : 'Unmuted';
        });
      }
      
      bindCanvasEvents() {
        this.canvas.addEventListener('click', (e) => this.handleClick(e));
      }
      
      setupTimeSignatureControl() {
        const timeSelect = this.controls.querySelector('.timeSignatureSelect');
        timeSelect.addEventListener('change', () => {
          this.autoTriggerInterval = parseInt(timeSelect.value);
          if (this.autoTriggerActive) {
            this.disableAutoTrigger();
            this.enableAutoTrigger();
          }
        });
      }
      
      handleClick(e) {
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        this.simulation.createExplosion(x, y);
        let frequency = getFrequencyFromY(y, this.canvas.height);
        const ragaFreq = getRagaFrequency(this.controls);
        if (ragaFreq) {
          frequency = ragaFreq;
        }
        if (!this.channelMuted) {
          playOscillatorSound(frequency, this.gainNode);
        }
      }
      
      autoTrigger() {
        const x = Math.random() * this.canvas.width;
        const y = Math.random() * this.canvas.height;
        this.simulation.createExplosion(x, y);
        let frequency = getFrequencyFromY(y, this.canvas.height);
        const ragaFreq = getRagaFrequency(this.controls);
        if (ragaFreq) {
          frequency = ragaFreq;
        }
        if (!this.channelMuted) {
          playOscillatorSound(frequency, this.gainNode);
        }
      }
      
      scheduleNextAutoTrigger() {
        if (!this.autoTriggerActive) return;
        const extraDelay = getRandomExtraDelay();
        const totalDelay = this.autoTriggerInterval + extraDelay;
        this.localAutoTriggerTimeout = setTimeout(() => {
          this.autoTrigger();
          this.scheduleNextAutoTrigger();
        }, totalDelay);
      }
      
      enableAutoTrigger() {
        this.autoTriggerActive = true;
        this.scheduleNextAutoTrigger();
      }
      
      disableAutoTrigger() {
        this.autoTriggerActive = false;
        if (this.localAutoTriggerTimeout) {
          clearTimeout(this.localAutoTriggerTimeout);
          this.localAutoTriggerTimeout = null;
        }
      }
    }
    
    // --- Master Controller for Synchronization and Scalability ---
    class MasterController {
      constructor() {
        this.quadrants = [];
        this.globalAutoTriggerActive = false;
        this.initQuadrants();
        this.setupGlobalControls();
      }
      
      initQuadrants() {
        const quadrantElements = document.querySelectorAll('.quadrant');
        quadrantElements.forEach((quadEl) => {
          const canvas = quadEl.querySelector('canvas');
          const controls = quadEl.querySelector('.controls');
          const gainNode = createQuadrantGainNode();
          const controller = new QuadrantController(canvas, controls, gainNode);
          this.quadrants.push(controller);
        });
      }
      
      setupGlobalControls() {
        const globalAutoTriggerBtn = document.getElementById('globalAutoTrigger');
        globalAutoTriggerBtn.addEventListener('click', () => this.toggleGlobalAutoTrigger());
      }
      
      toggleGlobalAutoTrigger() {
        this.globalAutoTriggerActive = !this.globalAutoTriggerActive;
        this.quadrants.forEach(q => {
          if (this.globalAutoTriggerActive) {
            q.enableAutoTrigger();
          } else {
            q.disableAutoTrigger();
          }
        });
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      const masterController = new MasterController();
    });
  </script>
</body>
</html>
