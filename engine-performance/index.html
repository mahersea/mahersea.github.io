<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Engine Performance Dyno</title>
  <meta name="description" content="Interactive engine dynamometer simulation with real-time performance curves and animated components">
  <style>
    body { 
      margin: 0; 
      background: #1a1a1a; 
      color: #ffffff;
      font-family: Arial, sans-serif; 
      overflow: hidden;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 400px;
      height: 100vh;
    }
    .engine-view {
      position: relative;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
    }
    .controls-panel {
      background: #222;
      padding: 20px;
      overflow-y: auto;
      border-left: 2px solid #444;
    }
    canvas {
      display: block;
    }
    .control-group {
      margin-bottom: 20px;
      padding: 15px;
      background: #333;
      border-radius: 8px;
    }
    .control-group h3 {
      margin: 0 0 10px 0;
      color: #00ff88;
      font-size: 14px;
      text-transform: uppercase;
    }
    .slider-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 8px 0;
    }
    .slider-group label {
      font-size: 12px;
      min-width: 80px;
    }
    input[type="range"] {
      flex: 1;
      margin: 0 10px;
    }
    .value-display {
      font-family: monospace;
      font-size: 12px;
      color: #00ff88;
      min-width: 50px;
      text-align: right;
    }
    button {
      background: #444;
      color: #fff;
      border: 1px solid #666;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin: 2px;
      font-size: 12px;
    }
    button:hover {
      background: #555;
    }
    button.active {
      background: #00aa44;
      border-color: #00ff88;
    }
    .performance-display {
      background: #1a1a1a;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 14px;
    }
    .metric {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
    }
    .metric-value {
      color: #00ff88;
      font-weight: bold;
    }
    .engine-config {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    .modifications {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    .chart-overlay {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 300px;
      height: 200px;
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid #444;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="engine-view">
      <canvas id="engineCanvas"></canvas>
      <div class="chart-overlay">
        <canvas id="chartCanvas"></canvas>
      </div>
    </div>
    
    <div class="controls-panel">
      <h2>üèÅ Engine Dyno</h2>
      
      <div class="performance-display">
        <div class="metric">
          <span>RPM:</span>
          <span class="metric-value" id="rpmDisplay">0</span>
        </div>
        <div class="metric">
          <span>Horsepower:</span>
          <span class="metric-value" id="hpDisplay">0</span>
        </div>
        <div class="metric">
          <span>Torque:</span>
          <span class="metric-value" id="torqueDisplay">0</span>
        </div>
        <div class="metric">
          <span>AFR:</span>
          <span class="metric-value" id="afrDisplay">14.7</span>
        </div>
        <div class="metric">
          <span>Boost:</span>
          <span class="metric-value" id="boostDisplay">0.0</span>
        </div>
        <div class="metric">
          <span>EGT:</span>
          <span class="metric-value" id="egtDisplay">800</span>
        </div>
      </div>
      
      <div class="control-group">
        <h3>Engine Configuration</h3>
        <div class="engine-config">
          <button id="config-i4" class="active">I4</button>
          <button id="config-v6">V6</button>
          <button id="config-v8">V8</button>
          <button id="config-rotary">Rotary</button>
        </div>
      </div>
      
      <div class="control-group">
        <h3>Engine Parameters</h3>
        <div class="slider-group">
          <label>Displacement:</label>
          <input type="range" id="displacement" min="1000" max="8000" value="2000">
          <span class="value-display" id="displacementValue">2.0L</span>
        </div>
        <div class="slider-group">
          <label>Compression:</label>
          <input type="range" id="compression" min="80" max="150" value="95">
          <span class="value-display" id="compressionValue">9.5:1</span>
        </div>
        <div class="slider-group">
          <label>Timing:</label>
          <input type="range" id="timing" min="5" max="40" value="15">
          <span class="value-display" id="timingValue">15¬∞</span>
        </div>
      </div>
      
      <div class="control-group">
        <h3>Fuel System</h3>
        <div class="slider-group">
          <label>Air/Fuel:</label>
          <input type="range" id="airFuel" min="120" max="180" value="147">
          <span class="value-display" id="airFuelValue">14.7</span>
        </div>
        <div class="slider-group">
          <label>Fuel Quality:</label>
          <input type="range" id="fuelQuality" min="87" max="110" value="91">
          <span class="value-display" id="fuelQualityValue">91</span>
        </div>
      </div>
      
      <div class="control-group">
        <h3>Forced Induction</h3>
        <div class="modifications">
          <button id="mod-na" class="active">N/A</button>
          <button id="mod-turbo">Turbo</button>
          <button id="mod-supercharger">S/C</button>
          <button id="mod-twinturbo">Twin</button>
        </div>
        <div class="slider-group">
          <label>Boost:</label>
          <input type="range" id="boost" min="0" max="30" value="0">
          <span class="value-display" id="boostValue">0.0 psi</span>
        </div>
      </div>
      
      <div class="control-group">
        <h3>Modifications</h3>
        <div class="modifications">
          <button id="mod-exhaust">Exhaust</button>
          <button id="mod-intake">Intake</button>
          <button id="mod-intercooler">I/C</button>
          <button id="mod-nitrous">N2O</button>
          <button id="mod-ecu">ECU</button>
        </div>
      </div>
      
      <div class="control-group">
        <h3>Dyno Controls</h3>
        <div class="slider-group">
          <label>RPM:</label>
          <input type="range" id="rpmControl" min="500" max="8000" value="1000">
          <span class="value-display" id="rpmControlValue">1000</span>
        </div>
        <button id="autoSweep">Auto RPM Sweep</button>
        <button id="redlineTest">Redline Test</button>
        <button id="resetDyno">Reset Dyno</button>
      </div>
    </div>
  </div>

  <script>
    // Canvas setup
    const engineCanvas = document.getElementById('engineCanvas');
    const engineCtx = engineCanvas.getContext('2d');
    const chartCanvas = document.getElementById('chartCanvas');
    const chartCtx = chartCanvas.getContext('2d');
    
    function resizeCanvases() {
      const container = document.querySelector('.engine-view');
      engineCanvas.width = container.clientWidth;
      engineCanvas.height = container.clientHeight;
      chartCanvas.width = 300;
      chartCanvas.height = 200;
    }
    resizeCanvases();
    window.addEventListener('resize', resizeCanvases);
    
    // Engine simulation state
    let currentRPM = 1000;
    let targetRPM = 1000;
    let engineConfig = 'i4';
    let displacement = 2000; // cc
    let compressionRatio = 9.5;
    let timing = 15; // degrees
    let airFuelRatio = 14.7;
    let fuelOctane = 91;
    let boostPressure = 0; // psi
    let forcedInduction = 'na';
    let modifications = new Set();
    let autoSweeping = false;
    let sweepDirection = 1;
    
    // Performance data
    let dynoData = [];
    let maxDataPoints = 100;
    
    // Animation state
    let pistonPositions = [0, 0, 0, 0, 0, 0, 0, 8]; // Phase offsets for different cylinders
    let crankAngle = 0;
    let turboSpeed = 0;
    
    // Engine configurations
    const engines = {
      i4: { cylinders: 4, layout: 'inline', firingOrder: [0, 2, 1, 3] },
      v6: { cylinders: 6, layout: 'v', firingOrder: [0, 2, 4, 1, 3, 5] },
      v8: { cylinders: 8, layout: 'v', firingOrder: [0, 4, 2, 6, 1, 5, 3, 7] },
      rotary: { cylinders: 3, layout: 'rotary', firingOrder: [0, 1, 2] }
    };
    
    // Calculate engine performance
    function calculatePerformance() {
      const config = engines[engineConfig];
      const cylinders = config.cylinders;
      
      // Base calculations
      const displacementLiters = displacement / 1000;
      const volumetricEfficiency = 0.8 + (timing - 15) * 0.01 + (modifications.has('intake') ? 0.1 : 0);
      const fuelEfficiency = 1.0 - Math.abs(airFuelRatio - 14.7) * 0.02;
      const octaneMultiplier = Math.min(fuelOctane / 91, 1.2);
      
      // RPM-dependent factors
      const rpmFactor = Math.max(0, 1 - Math.abs(currentRPM - 5500) / 6000);
      const peakRPM = 5500 + (modifications.has('ecu') ? 500 : 0);
      
      // Forced induction effects
      let pressureRatio = 1.0;
      if (forcedInduction !== 'na') {
        pressureRatio = 1 + (boostPressure / 14.7);
        if (modifications.has('intercooler')) {
          pressureRatio *= 1.1; // Better cooling = more power
        }
      }
      
      // Base torque calculation (simplified)
      let baseTorque = displacementLiters * 100 * volumetricEfficiency * fuelEfficiency * octaneMultiplier;
      baseTorque *= pressureRatio;
      
      // RPM curve shaping
      const torqueCurve = Math.exp(-Math.pow((currentRPM - peakRPM * 0.7) / (peakRPM * 0.3), 2));
      const torque = baseTorque * torqueCurve;
      
      // Horsepower = (Torque √ó RPM) / 5252
      const horsepower = (torque * currentRPM) / 5252;
      
      // Modifications
      let finalHP = horsepower;
      let finalTorque = torque;
      
      if (modifications.has('exhaust')) {
        finalHP *= 1.05;
        finalTorque *= 1.03;
      }
      if (modifications.has('nitrous')) {
        finalHP *= 1.25;
        finalTorque *= 1.15;
      }
      if (modifications.has('ecu')) {
        finalHP *= 1.08;
        finalTorque *= 1.05;
      }
      
      // EGT calculation
      const baseEGT = 800 + (currentRPM / 100) + (boostPressure * 20);
      const egt = baseEGT * (airFuelRatio < 14.7 ? 1.2 : 1.0);
      
      return {
        horsepower: Math.max(0, finalHP),
        torque: Math.max(0, finalTorque),
        egt: egt,
        afr: airFuelRatio,
        boost: boostPressure
      };
    }
    
    // Update performance displays
    function updateDisplays() {
      const perf = calculatePerformance();
      
      document.getElementById('rpmDisplay').textContent = Math.round(currentRPM);
      document.getElementById('hpDisplay').textContent = Math.round(perf.horsepower);
      document.getElementById('torqueDisplay').textContent = Math.round(perf.torque);
      document.getElementById('afrDisplay').textContent = perf.afr.toFixed(1);
      document.getElementById('boostDisplay').textContent = perf.boost.toFixed(1);
      document.getElementById('egtDisplay').textContent = Math.round(perf.egt) + '¬∞F';
      
      // Store data point
      dynoData.push({
        rpm: currentRPM,
        hp: perf.horsepower,
        torque: perf.torque
      });
      
      if (dynoData.length > maxDataPoints) {
        dynoData.shift();
      }
    }
    
    // Draw engine animation
    function drawEngine() {
      engineCtx.fillStyle = '#1a1a1a';
      engineCtx.fillRect(0, 0, engineCanvas.width, engineCanvas.height);
      
      const centerX = engineCanvas.width / 2;
      const centerY = engineCanvas.height / 2;
      const config = engines[engineConfig];
      
      if (config.layout === 'rotary') {
        drawRotaryEngine(centerX, centerY);
      } else {
        drawPistonEngine(centerX, centerY, config);
      }
      
      // Draw turbo if equipped
      if (forcedInduction === 'turbo' || forcedInduction === 'twinturbo') {
        drawTurbocharger(centerX + 150, centerY - 100);
      }
      
      // Draw performance indicators
      drawPerformanceIndicators();
    }
    
    function drawPistonEngine(centerX, centerY, config) {
      const cylinderWidth = 40;
      const cylinderHeight = 120;
      const cylinderSpacing = 50;
      
      // Engine block
      engineCtx.fillStyle = '#666666';
      const blockWidth = config.cylinders * cylinderSpacing + 20;
      engineCtx.fillRect(centerX - blockWidth/2, centerY - 60, blockWidth, 120);
      
      // Cylinders and pistons
      for (let i = 0; i < config.cylinders; i++) {
        const x = centerX - blockWidth/2 + 30 + i * cylinderSpacing;
        const y = centerY;
        
        // Cylinder
        engineCtx.fillStyle = '#444444';
        engineCtx.fillRect(x - cylinderWidth/2, y - cylinderHeight/2, cylinderWidth, cylinderHeight);
        
        // Piston animation
        const firingOrder = config.firingOrder[i];
        const pistonPhase = crankAngle + (firingOrder * 2 * Math.PI / config.cylinders);
        const pistonOffset = Math.sin(pistonPhase) * 25;
        
        // Piston
        engineCtx.fillStyle = '#cccccc';
        engineCtx.fillRect(x - cylinderWidth/2 + 5, y + pistonOffset - 8, cylinderWidth - 10, 16);
        
        // Connecting rod
        engineCtx.strokeStyle = '#999999';
        engineCtx.lineWidth = 3;
        engineCtx.beginPath();
        engineCtx.moveTo(x, y + pistonOffset);
        engineCtx.lineTo(x, y + 40);
        engineCtx.stroke();
        
        // Combustion flash
        if (Math.sin(pistonPhase + Math.PI) > 0.8) {
          const flash = Math.random() * 0.5 + 0.5;
          engineCtx.fillStyle = `rgba(255, 150, 0, ${flash})`;
          engineCtx.fillRect(x - cylinderWidth/2, y - cylinderHeight/2, cylinderWidth, 20);
        }
      }
      
      // Crankshaft
      engineCtx.fillStyle = '#888888';
      engineCtx.fillRect(centerX - blockWidth/2, centerY + 40, blockWidth, 20);
      
      // Rotating crankshaft indicator
      engineCtx.save();
      engineCtx.translate(centerX, centerY + 50);
      engineCtx.rotate(crankAngle);
      engineCtx.fillStyle = '#ffaa00';
      engineCtx.fillRect(-3, -15, 6, 30);
      engineCtx.restore();
    }
    
    function drawRotaryEngine(centerX, centerY) {
      const radius = 80;
      
      // Housing
      engineCtx.strokeStyle = '#666666';
      engineCtx.lineWidth = 8;
      engineCtx.beginPath();
      engineCtx.arc(centerX, centerY, radius, 0, Math.PI * 2);
      engineCtx.stroke();
      
      // Rotor
      engineCtx.save();
      engineCtx.translate(centerX, centerY);
      engineCtx.rotate(crankAngle * 3); // Rotor spins 3x faster
      
      engineCtx.fillStyle = '#cccccc';
      engineCtx.beginPath();
      for (let i = 0; i < 3; i++) {
        const angle = (i * 2 * Math.PI / 3);
        const x = Math.cos(angle) * 40;
        const y = Math.sin(angle) * 40;
        if (i === 0) engineCtx.moveTo(x, y);
        else engineCtx.lineTo(x, y);
      }
      engineCtx.closePath();
      engineCtx.fill();
      
      // Combustion chambers
      for (let i = 0; i < 3; i++) {
        const angle = (i * 2 * Math.PI / 3) + crankAngle;
        const combustionPhase = Math.sin(angle * 3);
        if (combustionPhase > 0.7) {
          const intensity = (combustionPhase - 0.7) / 0.3;
          engineCtx.fillStyle = `rgba(255, 150, 0, ${intensity})`;
          const x = Math.cos(angle) * 60;
          const y = Math.sin(angle) * 60;
          engineCtx.beginPath();
          engineCtx.arc(x, y, 15, 0, Math.PI * 2);
          engineCtx.fill();
        }
      }
      
      engineCtx.restore();
    }
    
    function drawTurbocharger(x, y) {
      // Turbo housing
      engineCtx.fillStyle = '#555555';
      engineCtx.beginPath();
      engineCtx.arc(x, y, 30, 0, Math.PI * 2);
      engineCtx.fill();
      
      // Spinning turbine
      engineCtx.save();
      engineCtx.translate(x, y);
      engineCtx.rotate(turboSpeed);
      
      engineCtx.strokeStyle = '#cccccc';
      engineCtx.lineWidth = 2;
      for (let i = 0; i < 6; i++) {
        const angle = (i * Math.PI / 3);
        engineCtx.beginPath();
        engineCtx.moveTo(0, 0);
        engineCtx.lineTo(Math.cos(angle) * 20, Math.sin(angle) * 20);
        engineCtx.stroke();
      }
      
      engineCtx.restore();
      
      // Boost pressure glow
      if (boostPressure > 0) {
        const intensity = Math.min(boostPressure / 20, 1);
        engineCtx.fillStyle = `rgba(0, 255, 255, ${intensity * 0.3})`;
        engineCtx.beginPath();
        engineCtx.arc(x, y, 35, 0, Math.PI * 2);
        engineCtx.fill();
      }
    }
    
    function drawPerformanceIndicators() {
      const perf = calculatePerformance();
      
      // RPM gauge
      const rpmX = 100;
      const rpmY = 100;
      const rpmRadius = 60;
      
      // RPM gauge background
      engineCtx.strokeStyle = '#444444';
      engineCtx.lineWidth = 8;
      engineCtx.beginPath();
      engineCtx.arc(rpmX, rpmY, rpmRadius, Math.PI, 2 * Math.PI);
      engineCtx.stroke();
      
      // RPM needle
      const rpmAngle = Math.PI + (currentRPM / 8000) * Math.PI;
      engineCtx.strokeStyle = currentRPM > 6500 ? '#ff4444' : '#00ff88';
      engineCtx.lineWidth = 3;
      engineCtx.beginPath();
      engineCtx.moveTo(rpmX, rpmY);
      engineCtx.lineTo(
        rpmX + Math.cos(rpmAngle) * (rpmRadius - 10),
        rpmY + Math.sin(rpmAngle) * (rpmRadius - 10)
      );
      engineCtx.stroke();
      
      // RPM label
      engineCtx.fillStyle = '#ffffff';
      engineCtx.font = '12px Arial';
      engineCtx.textAlign = 'center';
      engineCtx.fillText('RPM x1000', rpmX, rpmY + 80);
    }
    
    // Draw dyno chart
    function drawChart() {
      chartCtx.fillStyle = 'rgba(0, 0, 0, 0.9)';
      chartCtx.fillRect(0, 0, chartCanvas.width, chartCanvas.height);
      
      if (dynoData.length < 2) return;
      
      // Chart bounds
      const margin = 30;
      const chartWidth = chartCanvas.width - 2 * margin;
      const chartHeight = chartCanvas.height - 2 * margin;
      
      // Find data ranges
      const minRPM = Math.min(...dynoData.map(d => d.rpm));
      const maxRPM = Math.max(...dynoData.map(d => d.rpm));
      const maxHP = Math.max(...dynoData.map(d => d.hp));
      const maxTorque = Math.max(...dynoData.map(d => d.torque));
      const maxValue = Math.max(maxHP, maxTorque);
      
      // Draw grid
      chartCtx.strokeStyle = '#333333';
      chartCtx.lineWidth = 1;
      for (let i = 0; i <= 5; i++) {
        const y = margin + (i * chartHeight / 5);
        chartCtx.beginPath();
        chartCtx.moveTo(margin, y);
        chartCtx.lineTo(margin + chartWidth, y);
        chartCtx.stroke();
      }
      
      // Draw HP curve
      chartCtx.strokeStyle = '#ff4444';
      chartCtx.lineWidth = 2;
      chartCtx.beginPath();
      for (let i = 0; i < dynoData.length; i++) {
        const x = margin + ((dynoData[i].rpm - minRPM) / (maxRPM - minRPM)) * chartWidth;
        const y = margin + chartHeight - (dynoData[i].hp / maxValue) * chartHeight;
        if (i === 0) chartCtx.moveTo(x, y);
        else chartCtx.lineTo(x, y);
      }
      chartCtx.stroke();
      
      // Draw Torque curve
      chartCtx.strokeStyle = '#4444ff';
      chartCtx.lineWidth = 2;
      chartCtx.beginPath();
      for (let i = 0; i < dynoData.length; i++) {
        const x = margin + ((dynoData[i].rpm - minRPM) / (maxRPM - minRPM)) * chartWidth;
        const y = margin + chartHeight - (dynoData[i].torque / maxValue) * chartHeight;
        if (i === 0) chartCtx.moveTo(x, y);
        else chartCtx.lineTo(x, y);
      }
      chartCtx.stroke();
      
      // Labels
      chartCtx.fillStyle = '#ffffff';
      chartCtx.font = '10px Arial';
      chartCtx.textAlign = 'left';
      chartCtx.fillText('HP', 10, 20);
      chartCtx.fillStyle = '#ff4444';
      chartCtx.fillRect(25, 15, 15, 2);
      
      chartCtx.fillStyle = '#ffffff';
      chartCtx.fillText('TQ', 10, 35);
      chartCtx.fillStyle = '#4444ff';
      chartCtx.fillRect(25, 30, 15, 2);
    }
    
    // Control event listeners
    function setupControls() {
      // Engine config buttons
      document.querySelectorAll('[id^="config-"]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('[id^="config-"]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          engineConfig = btn.id.replace('config-', '');
          dynoData = []; // Reset dyno data
        });
      });
      
      // Forced induction buttons
      document.querySelectorAll('[id^="mod-"][id$="turbo"], #mod-na, #mod-supercharger').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('[id^="mod-"][id$="turbo"], #mod-na, #mod-supercharger').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          forcedInduction = btn.id.replace('mod-', '');
          if (forcedInduction === 'na') {
            boostPressure = 0;
            document.getElementById('boost').value = 0;
            document.getElementById('boostValue').textContent = '0.0 psi';
          }
        });
      });
      
      // Modification buttons
      document.querySelectorAll('#mod-exhaust, #mod-intake, #mod-intercooler, #mod-nitrous, #mod-ecu').forEach(btn => {
        btn.addEventListener('click', () => {
          const mod = btn.id.replace('mod-', '');
          if (modifications.has(mod)) {
            modifications.delete(mod);
            btn.classList.remove('active');
          } else {
            modifications.add(mod);
            btn.classList.add('active');
          }
        });
      });
      
      // Sliders
      const sliders = [
        { id: 'displacement', prop: 'displacement', display: 'displacementValue', format: v => (v/1000).toFixed(1) + 'L' },
        { id: 'compression', prop: 'compressionRatio', display: 'compressionValue', format: v => (v/10).toFixed(1) + ':1' },
        { id: 'timing', prop: 'timing', display: 'timingValue', format: v => v + '¬∞' },
        { id: 'airFuel', prop: 'airFuelRatio', display: 'airFuelValue', format: v => (v/10).toFixed(1) },
        { id: 'fuelQuality', prop: 'fuelOctane', display: 'fuelQualityValue', format: v => v },
        { id: 'boost', prop: 'boostPressure', display: 'boostValue', format: v => v + ' psi' },
        { id: 'rpmControl', prop: 'targetRPM', display: 'rpmControlValue', format: v => v }
      ];
      
      sliders.forEach(slider => {
        const element = document.getElementById(slider.id);
        const display = document.getElementById(slider.display);
        
        element.addEventListener('input', () => {
          const value = parseFloat(element.value);
          window[slider.prop] = value;
          display.textContent = slider.format(value);
        });
        
        // Initialize display
        display.textContent = slider.format(element.value);
      });
      
      // Control buttons
      document.getElementById('autoSweep').addEventListener('click', () => {
        autoSweeping = !autoSweeping;
        document.getElementById('autoSweep').textContent = autoSweeping ? 'Stop Sweep' : 'Auto RPM Sweep';
      });
      
      document.getElementById('redlineTest').addEventListener('click', () => {
        targetRPM = 7500;
        document.getElementById('rpmControl').value = 7500;
        document.getElementById('rpmControlValue').textContent = '7500';
      });
      
      document.getElementById('resetDyno').addEventListener('click', () => {
        dynoData = [];
        currentRPM = 1000;
        targetRPM = 1000;
        document.getElementById('rpmControl').value = 1000;
        document.getElementById('rpmControlValue').textContent = '1000';
      });
    }
    
    // Animation loop
    function animate() {
      // Update RPM
      if (autoSweeping) {
        targetRPM += sweepDirection * 30;
        if (targetRPM >= 7500) sweepDirection = -1;
        if (targetRPM <= 1000) sweepDirection = 1;
        document.getElementById('rpmControl').value = targetRPM;
        document.getElementById('rpmControlValue').textContent = targetRPM.toString();
      }
      
      // Smooth RPM transition
      currentRPM += (targetRPM - currentRPM) * 0.05;
      
      // Update animation
      crankAngle += (currentRPM / 60) * (2 * Math.PI) / 60; // Convert RPM to rad/s
      
      // Update turbo speed
      if (forcedInduction === 'turbo' || forcedInduction === 'twinturbo') {
        turboSpeed += (currentRPM / 1000) * 0.5;
      }
      
      updateDisplays();
      drawEngine();
      drawChart();
      
      requestAnimationFrame(animate);
    }
    
    // Initialize
    setupControls();
    animate();
  </script>
</body>
</html>